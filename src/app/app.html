<!-- Header -->
<header class="w-full bg-white border-b border-gray-100 shadow-sm">
  <div class="max-w-md mx-auto px-4 h-16 flex items-center gap-4">
    
    <div class="shrink-0 w-10 h-10">
      <img src="img/logo.png" alt="Logo" class="w-full h-full rounded-lg object-cover">
    </div>

    <div class="flex flex-col justify-center">
      <h1 class="font-black text-blue-900 leading-none italic text-lg uppercase">
        Pastillero-O-Matic
      </h1>
      <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">
        {{ miPrescripcion.paciente }}
      </p>
    </div>

  </div>
</header>


<!-- Mensaje de aviso, si lo hay -->
<div id="aviso" class="mt-6">
@if (miPrescripcion.mensaje.mostrar && !mensajeCerrado) {
  <div class="max-w-md mx-auto px-4 mb-6 animate__animated animate__pulse animate__infinite">
    <div [class]="'relative p-4 rounded-xl border-l-4 shadow-md flex gap-4 ' + 
      (miPrescripcion.mensaje.tipo === 'danger' ? 'bg-red-50 border-red-500 text-red-900' : 
       miPrescripcion.mensaje.tipo === 'warning' ? 'bg-amber-50 border-amber-500 text-amber-900' : 
       'bg-blue-50 border-blue-500 text-blue-900')">
      
      <div class="text-xl shrink-0">
        <i class="bi" [class]="miPrescripcion.mensaje.tipo === 'danger' ? 'bi-exclamation-triangle-fill' : 
                                miPrescripcion.mensaje.tipo === 'warning' ? 'bi-exclamation-circle-fill' : 
                                'bi-info-square-fill'"></i>
      </div>

      <div class="pr-6">
        <h4 class="font-bold text-sm uppercase tracking-tight">
          {{ miPrescripcion.mensaje.titulo || 'Aviso del Sistema' }}
        </h4>
        <p class="text-sm opacity-90 leading-snug mt-1">
          {{ miPrescripcion.mensaje.texto }}
        </p>
        
        @if (miPrescripcion.mensaje.fechaDesde || miPrescripcion.mensaje.fechaHasta) {
          <p class="text-[10px] mt-2 font-semibold opacity-60 italic">
            Válido: {{ miPrescripcion.mensaje.fechaDesde }} - {{ miPrescripcion.mensaje.fechaHasta }}
          </p>
        }
      </div>

      <button (click)="cerrarMensaje()" 
              class="absolute top-3 right-3 text-lg leading-none hover:scale-125 transition-transform opacity-50 hover:opacity-100">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>
}
</div>


<!-- Cuerpo principal. Se muestran todas las tomas, cada una con sus pastillas -->
<main class="max-w-md mx-auto px-4 space-y-8 pb-12">

    @for (toma of miPrescripcion.tomas; track toma.momento) {

    @if (toma.pastillas && toma.pastillas.length > 0) {

    <section class="mb-8 bg-white rounded-2xl shadow border border-gray-100 overflow-hidden">

        <div class="p-4 flex justify-between items-center" [style.backgroundColor]="toma.color || '#f3f4f6'">
            <div>
                <h2 class="text-xl font-bold text-gray-800">{{ toma.momento }}</h2>
                <span class="text-sm font-medium text-gray-600">
                    <i class="bi bi-clock me-1"></i>{{ toma.hora }}
                </span>
            </div>
            <i class="bi text-2xl text-gray-600" [class.bi-brightness-high]="toma.momento === 'Desayuno'"
                [class.bi-sun]="toma.momento === 'Comida'" [class.bi-moon-stars]="toma.momento === 'Cena'"></i>
        </div>

        <div class="p-4 divide-y divide-gray-100">
            @for (med of toma.pastillas; track med.nombre) {
            <div class="py-4 first:pt-0 last:pb-0">

                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-lg font-bold text-blue-900 leading-tight">{{ med.nombre }}</h3>
                        @if (med.principioActivo) {
                        <p class="text-xs text-gray-500 uppercase tracking-wide">{{ med.principioActivo }}</p>
                        }
                    </div>

                    <div class="flex gap-1 mt-1" title="Importancia: {{ med.importancia }}">
                        <div class="w-3 h-3 rounded-full shadow-sm"
                            [class]="med.importancia === 'alta' ? 'bg-red-500' : (med.importancia === 'media' ? 'bg-orange-400' : 'bg-green-500')">
                        </div>
                        <div class="w-3 h-3 rounded-full shadow-sm"
                            [class]="med.importancia === 'alta' ? 'bg-red-500' : (med.importancia === 'media' ? 'bg-orange-400' : 'bg-gray-200')">
                        </div>
                        <div class="w-3 h-3 rounded-full shadow-sm"
                            [class]="med.importancia === 'alta' ? 'bg-red-500' : 'bg-gray-200'">
                        </div>
                    </div>
                </div>

                <p class="text-gray-700 text-sm mb-1">
                    <span class="font-semibold text-blue-600">{{ med.cantidad }}</span> — {{ med.dosis }}
                </p>

                @if (med.observaciones || med.fotoCaja || med.fotoPastilla || med.motivo) {
                <details class="group border-t border-gray-50 mt-2 pt-2">
                    <summary
                        class="list-none cursor-pointer flex items-center text-[10px] text-gray-400 font-bold hover:text-blue-500 transition-colors tracking-widest">
                        <i class="bi bi-plus-circle me-1 group-open:hidden"></i>
                        <i class="bi bi-dash-circle me-1 hidden group-open:inline"></i>
                        <span>VER DETALLES</span>
                    </summary>

                    <div class="mt-3 space-y-3">
                        @if (med.motivo) {
                        <p class="text-xs text-gray-600 bg-gray-50 p-2 rounded border-l-2 border-blue-200 italic">
                            <strong>Para:</strong> {{ med.motivo }}
                        </p>
                        }

                        @if (med.observaciones) {
                        <p class="text-xs text-gray-600">
                            <i class="bi bi-info-circle me-1 text-blue-400"></i>{{ med.observaciones }}
                        </p>
                        }

                        <div class="flex gap-2">
                            @if (med.fotoCaja) {
                            <div class="w-1/2">
                                <p class="text-[9px] text-gray-400 mb-1 uppercase text-center font-bold">Caja</p>
                                <img [src]="med.fotoCaja"
                                    class="rounded-lg border border-gray-100 w-full h-24 object-cover shadow-sm"
                                    alt="Foto caja">
                            </div>
                            }
                            @if (med.fotoPastilla) {
                            <div class="w-1/2">
                                <p class="text-[9px] text-gray-400 mb-1 uppercase text-center font-bold">Pastilla</p>
                                <img [src]="med.fotoPastilla"
                                    class="rounded-lg border border-gray-100 w-full h-24 object-cover shadow-sm"
                                    alt="Foto pastilla">
                            </div>
                            }
                        </div>
                    </div>
                </details>
                }
            </div>
            }
        </div>
    </section>
    }

    } @empty {
    <p class="text-center text-gray-500 mt-10">No hay medicación programada.</p>
    }

</main>

<!-- Footer -->
<footer class="max-w-md mx-auto px-4 py-8 border-t border-gray-200">
  <div class="text-center text-gray-400 text-xs font-medium">
    <p>© 2026 · Pastillero-O-Matic</p>
    <p class="mt-2">
      Última actualización:
      <span>{{ obtenerHaceCuanto(miPrescripcion.ultimaActualizacion) }}</span>
      <span class="ml-1">({{ miPrescripcion.ultimaActualizacion }})</span>
    </p>
  </div>
</footer>