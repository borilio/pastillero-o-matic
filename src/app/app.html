<!-- Header -->
<header class="w-full bg-white border-b border-gray-100 shadow-sm">
  <div class="max-w-md mx-auto px-4 h-16 flex items-center gap-4">

    <div class="shrink-0 w-10 h-10">
      <img src="img/logo.png" alt="Logo" class="w-full h-full rounded-lg object-cover">
    </div>

    <div class="flex flex-col justify-center">
      <h1 class="font-black text-blue-900 leading-none italic text-lg uppercase">
        {{ appName }}
      </h1>
      <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">
        {{ miPrescripcion.paciente }}
      </p>
    </div>

  </div>
</header>


<!-- Mensaje de aviso, si lo hay -->
@if (mostrarAvisoPorFecha()){ <!-- Si estamos entre las dos fechas que debe mostrarlo -->
<div id="aviso" class="mt-6">
  @if (miPrescripcion.mensaje.mostrar && !mensajeCerrado) {
  <div class="max-w-md mx-auto px-4 mb-6 animate__animated animate__pulse animate__infinite">
    <div [class]="'relative p-4 rounded-xl border-l-4 shadow-md flex gap-4 ' + 
      (miPrescripcion.mensaje.tipo === 'danger' ? 'bg-red-50 border-red-500 text-red-900' : 
       miPrescripcion.mensaje.tipo === 'warning' ? 'bg-amber-50 border-amber-500 text-amber-900' : 
       'bg-blue-50 border-blue-500 text-blue-900')">

      <div class="text-xl shrink-0">
        <i class="bi" [class]="miPrescripcion.mensaje.tipo === 'danger' ? 'bi-exclamation-triangle-fill' : 
                                miPrescripcion.mensaje.tipo === 'warning' ? 'bi-exclamation-circle-fill' : 
                                'bi-info-square-fill'"></i>
      </div>

      <div class="pr-6">
        <h4 class="font-bold text-sm uppercase tracking-tight">
          {{ miPrescripcion.mensaje.titulo || 'Aviso del Sistema' }}
        </h4>
        <p class="text-sm opacity-90 leading-snug mt-1">
          {{ miPrescripcion.mensaje.texto }}
        </p>

        @if (miPrescripcion.mensaje.fechaDesde || miPrescripcion.mensaje.fechaHasta) {
        <p class="text-[10px] mt-2 font-semibold opacity-60 italic">
          Válido desde el {{ miPrescripcion.mensaje.fechaDesde | date: 'longDate' }} hasta {{
          miPrescripcion.mensaje.fechaHasta | date: 'longDate' }}
        </p>
        }
      </div>

      <button (click)="cerrarMensaje()"
        class="absolute top-3 right-3 text-lg leading-none hover:scale-125 transition-transform opacity-50 hover:opacity-100">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>
  }
</div>
}

<!-- Cuerpo principal. Se muestran todas las tomas, cada una con sus pastillas -->
<main class="max-w-md mx-auto px-4 space-y-8 pb-12 mt-6">
  @for (toma of miPrescripcion.tomas; track toma.momento) {
  @if (toma.pastillas && toma.pastillas.length > 0) {
  <section class="mb-8 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

    <div class="p-4 flex justify-between items-center bg-gradient-to-l from-white/30 to-transparent"
      [class]="getContraste(toma.color || '')" [style.backgroundColor]="toma.color || '#f3f4f6'">
      <div>
        <h2 class="text-xl font-bold  uppercase tracking-tight">{{ toma.momento }}</h2>
        <span class="text-sm font-medium opacity-80">
          <i class="bi bi-clock-history me-1"></i>{{ toma.hora }}
        </span>
      </div>
      <i class="text-3xl opacity-80" [class]="toma.icono || 'bi bi-prescription2'"></i>
    </div>

    <div class="p-4 divide-y-2 divide-gray-200">
      @for (med of toma.pastillas; track med.nombre) {
      <div class="py-4 first:pt-0 last:pb-0">

        <div class="flex justify-between items-center mb-1">
          <h3 class="text-lg font-black text-blue-900 leading-none">
            {{ med.nombre }}
          </h3>

          <div class="flex gap-1" title="Importancia: {{ med.importancia }}">
            @let niveles = [1, 2, 3];
            @for (n of niveles; track n) {
            <div class="w-2.5 h-2.5 rounded-full shadow-inner" [class]="med.importancia === 'alta' ? 'bg-red-500' : 
                               (med.importancia === 'media' && n < 3 ? 'bg-orange-400' : 
                               (med.importancia === 'baja' && n === 1 ? 'bg-green-500' : 'bg-gray-200'))">
            </div>
            }
          </div>
        </div>

        <p class="text-gray-600 text-sm">
          <span class="font-bold text-blue-600">{{ med.cantidad }}</span>
          <span class="mx-1 text-gray-300">|</span>
          {{ med.dosis }}
        </p>

        <details class="group mt-3">
          <summary class="list-none cursor-pointer flex justify-end">
            <div
              class="inline-flex items-center px-5 py-2 rounded-full border border-gray-200 shadow active:scale-95 text-xs font-bold text-gray-400 group-open:bg-blue-50 group-open:border-blue-200 group-open:text-blue-600 transition-all tracking-widest">
              <i class="bi bi-plus-circle me-1.5 group-open:hidden"></i>
              <i class="bi bi-dash-circle me-1.5 hidden group-open:inline"></i>
              <span>Detalles</span>
            </div>
          </summary>

          <div class="mt-4 space-y-4 animate__animated animate__fadeInDown">

            <div class="grid grid-cols-2 gap-2">
              <div class="bg-teal-50 p-2 rounded-lg border-l-2 border-teal-400">
                <p class="text-[9px] uppercase font-bold text-teal-500/80">Principio activo</p>
                <p class="text-xs font-semibold text-teal-900">{{ med.principioActivo }}</p>
              </div>

              @if (med.motivo) {
              <div class="bg-pink-50 p-2 rounded-lg border-l-2 border-pink-300">
                <p class="text-[9px] uppercase font-bold text-pink-400">¿Para qué es?</p>
                <p class="text-xs font-semibold text-pink-800">{{ med.motivo }}</p>
              </div>
              }
            </div>

            @if (med.observaciones) {
            <div
              class="text-xs text-gray-600 flex gap-2 items-start bg-amber-50/50 p-2 rounded-lg border border-amber-300">
              <i class="bi bi-info-circle-fill text-amber-500 mt-0.5"></i>
              <p><strong>Nota:</strong> {{ med.observaciones }}</p>
            </div>
            }

            <!-- Fotos de la caja o pastilla -->
            <div class="flex flex-wrap justify-center gap-4">

              @if (med.fotoCaja) {
              <div class="w-32 bg-violet-100 rounded-xl border border-violet-100 shadow">
                <div class="py-1 bg-violet-100/50 border-b border-violet-100">
                  <p class="text-[9px] text-violet-600 uppercase font-black text-center tracking-widest">Caja</p>
                </div>
                <img [src]="'photos/' + med.fotoCaja" class="w-full h-24 object-cover rounded-b-xl bg-violet-50">
              </div>
              }

              @if (med.fotoPastilla) {
              <div class="w-32 bg-violet-100 rounded-xl border border-violet-100 shadow">
                <div class="py-1 bg-violet-100/50 border-b border-violet-100">
                  <p class="text-[9px] text-violet-600 uppercase font-black text-center tracking-widest">Pastilla</p>
                </div>
                <img [src]="'photos/' + med.fotoPastilla" class="w-full h-24 object-cover rounded-b-xl bg-violet-50">
              </div>
              }

            </div>
            <!-- Fin de las fotos -->

          </div>
        </details>

      </div>
      }
    </div>
  </section>
  }
  } @empty {
  <div class="text-center py-12 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
    <i class="bi bi-calendar-x text-4xl text-gray-300"></i>
    <p class="text-gray-500 mt-2 font-medium">No hay medicación para hoy.</p>
  </div>
  }
</main>

<!-- Footer -->
<footer class="max-w-md mx-auto px-4 py-8 border-t border-gray-200">
  <div class="text-center text-gray-400 text-xs font-medium">
    <p>© 2026 · {{ appName | uppercase }} <span class="text-gray-300">v{{ appVersion }}</span></p>
    <p class="mt-2">
      Última actualización:
      <span>{{ obtenerHaceCuanto(miPrescripcion.ultimaActualizacion) }}</span>
      <span class="ml-1">({{ miPrescripcion.ultimaActualizacion | date: 'longDate' }})</span>
    </p>
  </div>
</footer>